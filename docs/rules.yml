# --- NEW / UPDATED SETS ---
sets:
  port_groups:
    admin_ports: [22,23,3389,5900,5985,5986,445,135,139,20,21]
    insecure_cleartext: [23,20,21,69,110,143]
    windows_admin: [135,137,139,445]
    web_like: [80,443,8080,8443]
  addr_names:
    # Treat these names as “internet-like” (no CIDR in export)
    internet_like: ["any","all","All_Internet","WAN-DAAS_21","EWAN-DAAS_408","WAN_21","EWAN-FW_408","EXT-PRD-VL0", "Any","ANY","Internet","INTERNET","External","EXTERNAL","Public","PUBLIC","Outside","OUTSIDE","0.0.0.0/0","::/0","WAN","WAN-EDGE","WAN_CORE"]
    # Example internal/corp buckets if you want to scope later
    internal_like: ["CLIENT1DEV_79","CLIENT1_AllNets","CLIENT1_Nets","IN-PROD-VL0","Inter-FWL-VLAN4","PROD-DEV1","Transit_1010"]
    transit_or_core_like: [ "Core","Core_Switch","Core_Net","Backbone","Transit","Transit_1010","MPLS_Core","DC_Core","Distribution","Internal_Servers" ]
    user_or_workstation_like: [ "Internal_Net","LAN","Users_Net","Workstations","Staff_WiFi","Branch_LAN","HQ_LAN" ]


# --- REPLACE rule references to CIDRs/DIRECTION with name overlaps ---
rules:

  # Allow any-any-any (works for name-based exports)
  - id: R-ALLOW-ANY-ANY-ANY
    name: "Allow any↔any with any service"
    severity: critical
    rationale: "This type of rule removes all protection by allowing any source, any destination, and any service. It’s often left over from troubleshooting and creates total exposure."
    recommendation: "Remove this rule entirely. Create specific rules for required applications or temporarily allow traffic only for approved maintenance."
    when:
      all:
        - { field: action, op: equals, value: allow }
        - { field: src_addrs, op: overlaps, value: [ "any" ] }
        - { field: dst_addrs, op: overlaps, value: [ "any" ] }
        - { field: service.any, op: is_true, value: true }




  # Admin ports exposed (no 'direction', so just key off internet-like)
  - id: R-ADMIN-OPEN
    name: "Admin ports exposed to/from internet-like"
    severity: critical
    rationale: "Administrative services like RDP, SSH, and WinRM should never be directly reachable from untrusted networks. Attackers routinely scan for these ports."
    recommendation: "Limit access to admin ports through a VPN or jump host. Allow only trusted IPs, enforce MFA, and enable logging and lockout policies."
    when:
      all:
        - { field: action, op: equals, value: allow }
        - any:
            - { field: src_addrs, op: overlaps, value: { set_ref: addr_names.internet_like } }
            - { field: dst_addrs, op: overlaps, value: { set_ref: addr_names.internet_like } }
        - { field: service.ports, op: overlaps_range, value: { set_ref: port_groups.admin_ports } }

  - id: R-INSECURE-CLEARTEXT
    name: "Insecure clear-text protocols allowed broadly"
    severity: high
    rationale: "Clear-text protocols send usernames and passwords without encryption, allowing attackers to capture credentials or data in transit."
    recommendation: "Replace Telnet/FTP/POP3/IMAP with secure equivalents (SSH, SFTP, IMAPS, POP3S). Disable legacy services entirely where possible."
    when:
      all:
        - { field: action, op: equals, value: allow }
        - any:
            # internet-like
            - { field: src_addrs, op: overlaps, value: { set_ref: addr_names.internet_like } }
            - { field: dst_addrs, op: overlaps, value: { set_ref: addr_names.internet_like } }
            # broaden to user↔core/transit
            - all:
                - { field: src_addrs, op: overlaps, value: { set_ref: addr_names.transit_or_core_like } }
                - { field: dst_addrs, op: overlaps, value: { set_ref: addr_names.user_or_workstation_like } }
            - all:
                - { field: dst_addrs, op: overlaps, value: { set_ref: addr_names.transit_or_core_like } }
                - { field: src_addrs, op: overlaps, value: { set_ref: addr_names.user_or_workstation_like } }

        - any:
            # NUMERIC port check (engine-friendly)
            - service:
                ports:
                  any:
                    in: [ 20,21,23,69,110,143,161,162,512,513,514 ]
            # Named services fallback
            - { field: raw.service, op: ilike_any, value: [ "ftp","tftp","telnet","rlogin","rsh","pop3","imap","snmp" ] }


  - id: R-WINDOWS-ADMIN
    name: "Windows admin services exposed"
    severity: high
    rationale: "Windows administrative ports (135, 137, 139, 445) enable remote file and printer sharing. When reachable between networks they allow lateral movement or ransomware spread."
    recommendation: "Restrict or block these ports between VLANs. Keep SMB only inside internal management zones and enable SMB signing."
    when:
      all:
        - { field: action, op: equals, value: allow }
        - { field: service.any, op: is_false, value: true }   # <— add this
        - any:
            - { field: src_addrs, op: overlaps, value: { set_ref: addr_names.internet_like } }
            - { field: dst_addrs, op: overlaps, value: { set_ref: addr_names.internet_like } }
        - any:
            - { field: service.ports, op: overlaps_range, value: [ 135,135 ] }
            - { field: service.ports, op: overlaps_range, value: [ 137,137 ] }
            - { field: service.ports, op: overlaps_range, value: [ 139,139 ] }
            - { field: service.ports, op: overlaps_range, value: [ 445,445 ] }


  - id: R-RDP-EXPOSED
    name: "RDP allowed broadly"
    severity: critical
    rationale: "RDP is heavily targeted for brute-force and exploit attacks. Broad exposure allows direct access to internal desktops or servers."
    recommendation: "Publish RDP only through VPN or a secure gateway. Require Network Level Authentication and strong passwords; disable external RDP if not essential."
    when:
      all:
        - { field: action, op: equals, value: allow }
        - { field: service.any, op: is_false, value: true }   # <— add this
        - any:
            - { field: src_addrs, op: overlaps, value: { set_ref: addr_names.internet_like } }
            - { field: dst_addrs, op: overlaps, value: { set_ref: addr_names.internet_like } }
        - { field: service.ports, op: overlaps_range, value: [ 3389,3389 ] }


  - id: R-SSH-BROAD
    name: "SSH broadly allowed"
    severity: medium
    rationale: "Open SSH to wide networks increases the attack surface for brute-force and credential-stuffing attacks."
    recommendation: "Restrict SSH to specific admin IPs or a bastion host. Enforce key-based login and disable password authentication."
    when:
      all:
        - { field: action, op: equals, value: allow }
        - { field: service.any, op: is_false, value: true }   # <— add this
        - any:
            - { field: src_addrs, op: overlaps, value: { set_ref: addr_names.internet_like } }
            - { field: dst_addrs, op: overlaps, value: { set_ref: addr_names.internet_like } }
        - { field: service.ports, op: overlaps_range, value: [ 22,22 ] }


  - id: R-ICMP-ANY
    name: "ICMP broadly allowed"
    severity: low
    rationale: "Allowing all ICMP types helps attackers map internal networks and identify hosts."
    recommendation: "Allow only required ICMP types (echo request/reply). Apply rate-limits and restrict to trusted monitoring systems."
    when:
      all:
        - { field: action, op: equals, value: allow }
        - any:
            - { field: src_addrs, op: overlaps, value: { set_ref: addr_names.internet_like } }
            - { field: dst_addrs, op: overlaps, value: { set_ref: addr_names.internet_like } }
        - { field: service.has_icmp, op: is_true, value: true }



  # Keep your existing, but it’s good — it’s why you got hits
  - id: R-WIDE-PORT-SPAN
    name: "Very wide service port span"
    severity: medium
    rationale: "Rules with “any” service or thousands of ports increase attack surface and complicate monitoring."
    recommendation: "Replace “any” with specific ports needed. Document business justification and review yearly."
    when:
      all:
        - { field: action, op: equals, value: allow }

        - any:
            # 1) Explicit ANY/ALL service objects (often map to ports: [])
            - { field: service.any, op: is_true, value: true }
            - { field: raw.service, op: ilike_any, value: [ "all", "any", "lpdw0rm" ] }   # keep your vendor-specific aliases

            # 2) A single wide range in any service (big ephemeral ranges, etc.)
            - service:
                ports:
                  any:
                    to_from_diff_gte: 1024

            # 3) Lots of discrete ports enumerated (catch “wide” by count, not range)
            - { field: service.port_count, op: gte, value: 10 }   # if your engine supports this

            # 4) Multiple smaller ranges that are wide in total (sum across ports)
            - { field: service.port_span_total, op: gte, value: 2048 }  # if supported

  # HTTP anywhere (internal) — mirrors the uni “use HTTPS where possible”
  - id: R-HTTP-ALLOWED
    name: "HTTP allowed (80/tcp)"
    severity: low
    rationale: "Plain HTTP transmits data unencrypted and may allow interception of credentials."
    recommendation: "Use HTTPS for all web applications. Keep port 80 only for automatic redirects and enforce TLS 1.2+."
    when:
      all:
        - { field: action, op: equals, value: allow }
        # don't fire on 'ALL' services
        - { field: service.any, op: is_false, value: true }
        - any:
            # explicit port 80
            - { field: service.ports, op: overlaps_range, value: [ 80,80 ] }
            # fallback to name, but exclude https
            - all:
                - { field: raw.service, op: ilike_any, value: [ "http" ] }
                - { field: raw.service, op: not_ilike_any, value: [ "https" ] }

  - id: R-HTTP-INTERNET
    name: "HTTP exposed to/from internet-like"
    severity: medium
    rationale: "Internet-facing HTTP should be encrypted; attackers can modify or intercept unprotected traffic."
    recommendation: "Disable external HTTP or redirect to HTTPS via a secure reverse proxy/WAF."
    when:
      all:
        - { field: action, op: equals, value: allow }
        - { field: service.any, op: is_false, value: true }
        - any:
            - { field: service.ports, op: overlaps_range, value: [ 80,80 ] }
            - all:
                - { field: raw.service, op: ilike_any, value: [ "http" ] }
                - { field: raw.service, op: not_ilike_any, value: [ "https" ] }
        - any:
            - { field: src_addrs, op: overlaps, value: { set_ref: addr_names.internet_like } }
            - { field: dst_addrs, op: overlaps, value: { set_ref: addr_names.internet_like } }

  - id: R-SMTP-INTERNET
    name: "SMTP exposed to/from internet-like"
    severity: low
    rationale: "Open SMTP can be exploited for spam relays or phishing. Unencrypted email traffic leaks credentials."
    recommendation: "Route all outbound mail through a secured relay. Enforce STARTTLS and restrict inbound SMTP to approved mail servers."
    when:
      all:
        - { field: action, op: equals, value: allow }
        - { field: service.any, op: is_false, value: true }   # <— add this
        - any:
            - { field: src_addrs, op: overlaps, value: { set_ref: addr_names.internet_like } }
            - { field: dst_addrs, op: overlaps, value: { set_ref: addr_names.internet_like } }
        - any:
            - { field: service.ports, op: overlaps_range, value: [ 25,25 ] }
            - { field: service.ports, op: overlaps_range, value: [ 587,587 ] }

  # Ignore ANY→ANY when both sides are internal
  - id: R-IGNORE-INTERNAL-ANY-ANY
    name: Ignore internal any-to-any
    severity: low
    rationale: "Some internal any-any rules are intentional for segmentation testing; these are ignored to reduce noise."
    recommendation: "No action required. Ensure tagging of internal networks is accurate so true external exposure isn’t ignored."
    when:
      all:
        - field: services_protocol
          op: equals
          value: any
        - field: src_is_internal
          op: equals
          value: true
        - field: dst_is_internal
          op: equals
          value: true
    then:
      action: ignore

  - id: R-IGNORE-INTERNAL-HTTP
    name: Ignore internal HTTP (tcp/80) east-west
    severity: low
    rationale: "Internal HTTP traffic between trusted systems is common and not risky if segmented properly."
    recommendation: "No action required. Continue monitoring; review if zero-trust architecture is implemented."
    when:
      all:
        - field: services_tcp_ports
          op: contains
          value: 80
        - field: src_is_internal
          op: equals
          value: true
        - field: dst_is_internal
          op: equals
          value: true
    then:
      action: ignore